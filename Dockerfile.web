# Multi-stage Dockerfile for Expo web build served by Nginx

# Stage 1: Build Expo web static files
FROM node:20-alpine AS builder

WORKDIR /app

# Install OS deps
RUN apk add --no-cache python3 make g++
RUN npm i -g npm@11 && corepack enable || true

# Non-interactive builds
ENV CI=true EXPO_NO_TELEMETRY=1

# Copy package manifests first for better layer caching (strict npm ci)
COPY package.json package-lock.json* ./

# Install deps (prefer yarn if lockfile exists) with robust npm fallback
ENV npm_config_fund=false npm_config_audit=false
RUN npm ci

# Copy source
COPY . .

# Ensure Expo CLI available
RUN npx --yes expo@latest --version

# Export static web site to dist
RUN npx expo export --platform web --output-dir dist

# Stage 2: Nginx to serve static content
FROM nginx:1.27-alpine AS runtime

# Copy built site
COPY --from=builder /app/dist /usr/share/nginx/html

# Copy default nginx config tuned for SPA
RUN rm -f /etc/nginx/conf.d/default.conf

# Simple SPA config: redirect all to index.html
RUN printf "server {\n  listen 80;\n  server_name _;\n  root /usr/share/nginx/html;\n  index index.html;\n  location / {\n    try_files \$uri \$uri/ /index.html;\n  }\n  location ~* \\.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2)$ {\n    expires 7d;\n    access_log off;\n  }\n}\n" > /etc/nginx/conf.d/site.conf

EXPOSE 80

# Healthcheck: index.html exists
HEALTHCHECK --interval=30s --timeout=5s --start-period=20s --retries=3 CMD [ -f /usr/share/nginx/html/index.html ] || exit 1

CMD ["nginx", "-g", "daemon off;"]